---
title: "CS_P3"
author: "Boyana Buyuklieva"
date: "August 30, 2022"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache.lazy = FALSE)
# library(dplyr)
# library(tidyverse)
# library(data.table)
# library(readr)
# library(foreign)
# library(ggExtra)
# library(gridExtra)


# loads: loadRData
source("../Outputs/Thesis_custom_scripts.R", local = knitr::knit_global())
#big_SC_dt<- loadRData( paste0("../Data/RData_crossSectional/big_crossSect_EPCs_cleaned_N16m984358.RData") )
#save(additional_dt, file = paste0("../Data/RData_crossSectional/big_crossSect_EPCs_cleaned_N16m984358_additional_dt.RData") )



#formatting:
lettermapping <-  data.frame( letter = c('A','B','C','D','E','F','G'), 
                              cutoff = c(92, 81, 69, 55, 39, 21, 0))

EDA_cols <- read_csv("../Data/EDA_colour_scheme.csv")
#EDA_cols <- subset(EDA_cols[EDA_cols$geography_name %in%  cross_data, ])

###IMD:LOAD DATA
#multiple deprivation EW
IMD19<- read.dbf("../Data/_shapefiles/Lower_Super_Output_Area_(LSOA)_IMD_2019__(OSGB1936)/Lower_Super_Output_Area_(LSOA)_IMD_2019__(OSGB1936).dbf")

#income deprivation E
income_imd2019lsoa_E <- fread("../Data/imd2019lsoa/imd2019lsoa.csv",
                     drop="Units", #empty column anyway
                     colClasses = c( "FeatureCode" = "character",
                                     "Measurement" = "character",
                                     "Value" = "numeric",
                                     "Indices of Deprivation" = "character"))
#Measurements are: "Rank"   "Decile" "Score"
#income_imd2019lsoa_E <- setNames(income_imd2019lsoa_E, c("lsoa11cd","Date","Measurement","Value","Indices of Deprivation") )
setnames(income_imd2019lsoa_E, c("FeatureCode"), c("lsoa11cd"))



#get loopUp
LUT_tenure <- read_excel("../Data/OS-N_EPC_v10_LUT+dictionaries.xlsx", sheet = "TENURE",range = cell_cols("B:C"))
LUT_builtForm <- read_excel("../Data/OS-N_EPC_v10_LUT+dictionaries.xlsx", sheet = "BUILT_FORM",range = cell_cols("B:C"))
#LUT_age_band <- entries_to_factors(column_to_extract_factors_from = "CONSTRUCTION_AGE_BAND")
#LUT_transaction <- entries_to_factors(column_to_extract_factors_from = "TRANSACTION_TYPE")
```

```{r change_col_based_on_LUTs}
  #N: create new Tenure column
  LUT_colum <- LUT_tenure[match(big_Dt_CSsubset_N6M7$TENURE, LUT_tenure$tenure_factors),"harmonisation"]
  big_Dt_CSsubset_N6M7[,n_tenure := LUT_colum]
  big_Dt_CSsubset_N6M7[is.na(n_tenure),n_tenure := 'unknown'] #deals with NAs
      
  #N: create new Built Form column
  LUT_colum <- LUT_builtForm[match(big_Dt_CSsubset_N6M7$BUILT_FORM, LUT_builtForm$BUILT_FORMfactors),"harmonisation"]
  big_Dt_CSsubset_N6M7[,n_builtForm := LUT_colum]
  big_Dt_CSsubset_N6M7[is.na(n_builtForm),n_builtForm := 'unknown'] 
```


```{r resolving building age}
#Combine age bands in 2007 onwards



```







```{r UPRN_match_colums}
#CREATE NEW COLUMNS
#N1: info on UPRNs differences and NAs
big_Dt_CSsubset_N6M7[, n_erNoUPRN := ifelse(UPRN == ubdc_UPRN,'same','diffUPRNs')]
big_Dt_CSsubset_N6M7[, n_erNoUPRN := ifelse(UPRN == "" | is.na(UPRN),'diffUPRNs_NA_UPRN',n_erNoUPRN) ]
big_Dt_CSsubset_N6M7[, n_erNoUPRN := ifelse(ubdc_UPRN == ""| is.na(ubdc_UPRN),'diffUPRNs_NA_ubdc_UPRN',n_erNoUPRN) ]
big_Dt_CSsubset_N6M7[, n_erNoUPRN := ifelse(n_UPRN == "" | is.na(n_UPRN),'noUPRN',n_erNoUPRN) ]
```

```{r misc_Crel & rooms}
#N2: create C relative column
big_Dt_CSsubset_N6M7[, n_Crel:= ifelse(CURRENT_ENERGY_RATING == 'C', 'C', 
                                       ifelse(CURRENT_ENERGY_RATING %in% c('A', 'B'), 'C+', 
                                              ifelse(CURRENT_ENERGY_RATING %in% c('D', 'E','F','G'),'C-','NA' )))]
#big_Dt_CSsubset_N6M7[CURRENT_ENERGY_RATING =="INVALID!", ]$CURRENT_ENERGY_EFFICIENCY
big_Dt_CSsubset_N6M7[n_Crel =="NA", n_Crel:= ifelse(CURRENT_ENERGY_EFFICIENCY > 100, 'C+', 'C-')]
  


#Formatting n_Crel:
fctr_levels <- c("C+","C","C-")
big_Dt_CSsubset_N6M7[,n_Crel := factor(n_Crel, levels = fctr_levels, ordered = T)]
#Formatting NUMBER_HABITABLE_ROOMS:
#tally <- big_Dt_CSsubset_N6M7[, .(n = .N) ,by=NUMBER_HABITABLE_ROOMS ]
big_Dt_CSsubset_N6M7[, NUMBER_HABITABLE_ROOMS:=as.integer(NUMBER_HABITABLE_ROOMS)]
```



```{r attach_IMDs}
##ATTACH DATA 
big_Dt_CSsubset_N6M7[IMD19,  on = 'lsoa11cd', c('n_IMDRank','n_IMDDecil') := .(IMDRank,IMDDecil)]

#Add IoD
##can select other IoD here
#b.income
imd_bincome <-  income_imd2019lsoa_E[ `Indices of Deprivation` == "b. Income Deprivation Domain",]
imd_bincome <-dcast(imd_bincome, lsoa11cd ~ Measurement, value.var = c("Value"))
big_Dt_CSsubset_N6M7[imd_bincome,  on = 'lsoa11cd', c('n_bIoDRank_income','n_bIoDDecil_income') := .(Rank,Decile)]
#g.barriers
imd_gbarriers <-  income_imd2019lsoa_E[ `Indices of Deprivation` == "g. Barriers to Housing and Services Domain",]
imd_gbarriers <-dcast(imd_gbarriers, lsoa11cd ~ Measurement, value.var = c("Value"))
big_Dt_CSsubset_N6M7[imd_gbarriers,  on = 'lsoa11cd', c('n_gIoDRank_barriers','n_gIoDDecil_barriers') := .(Rank,Decile)]
```
 
```{r extreme_values_treatment}
#Edit 1: CEE values over 100 are set to 101
#round(quantile(big_Dt_CSsubset_N6M7$CURRENT_ENERGY_EFFICIENCY, 0.99, na.rm = T),0) # 87
big_Dt_CSsubset_N6M7[, n_CURRENT_ENERGY_EFFICIENCY := ifelse( CURRENT_ENERGY_EFFICIENCY>100 ,101, CURRENT_ENERGY_EFFICIENCY)]
# round(quantile(big_Dt_CSsubset_N6M7$POTENTIAL_ENERGY_EFFICIENCY, 0.99, na.rm = T),0) # 97
big_Dt_CSsubset_N6M7[, n_POTENTIAL_ENERGY_EFFICIENCY := ifelse( POTENTIAL_ENERGY_EFFICIENCY>100 ,101, POTENTIAL_ENERGY_EFFICIENCY)]

#Edit 2: EIC values over 100 are set to 101
# round(quantile(big_Dt_CSsubset_N6M7$ENVIRONMENT_IMPACT_CURRENT, 0.99, na.rm = T),0) # 92
big_Dt_CSsubset_N6M7[, n_ENVIRONMENT_IMPACT_CURRENT := ifelse( ENVIRONMENT_IMPACT_CURRENT>100 ,101, ENVIRONMENT_IMPACT_CURRENT)]
#round(quantile(big_Dt_CSsubset_N6M7$ENVIRONMENT_IMPACT_POTENTIAL, 0.99, na.rm = T),0) # 99
big_Dt_CSsubset_N6M7[, n_ENVIRONMENT_IMPACT_POTENTIAL := ifelse( ENVIRONMENT_IMPACT_POTENTIAL>100 ,101, ENVIRONMENT_IMPACT_POTENTIAL)]

#Edit 3: Places with over 7 habitable rooms are grouped together into 7+
#round(quantile(big_Dt_CSsubset_N6M7$NUMBER_HABITABLE_ROOMS, 0.99, na.rm = T),0) # is 10
fctr_levels <- c(paste0(seq(1,9,1), 'HaR'), '+10HaR' )
big_Dt_CSsubset_N6M7[ , n_habitable_rooms_grp := ifelse( NUMBER_HABITABLE_ROOMS>9,'+10HaR', paste0(NUMBER_HABITABLE_ROOMS,'HaR'))]
big_Dt_CSsubset_N6M7[ , n_habitable_rooms_grp := factor(n_habitable_rooms_grp, levels = fctr_levels, ordered = T)]

#Edit 4: Places with over 9 heated rooms are grouped together into 8+
#round(quantile(big_Dt_CSsubset_N6M7$NUMBER_HEATED_ROOMS, 0.99, na.rm = T),0) # is 9
fctr_levels <- c(paste0(seq(1,8,1), 'HtR'), '+9HtR' )
big_Dt_CSsubset_N6M7[ , n_heated_rooms_grp := ifelse( NUMBER_HEATED_ROOMS>8,'+9HtR', paste0(NUMBER_HEATED_ROOMS,'HtR'))]
big_Dt_CSsubset_N6M7[ , n_heated_rooms_grp := factor(n_heated_rooms_grp, levels = fctr_levels, ordered = T)]

#Edit 5: Floor Area. 
#Note min bedroom size is 6.5m2 = 7m2
#Max is 270, based on the 99 percentile of the entries
maxthreshold <- round(quantile(big_Dt_CSsubset_N6M7$TOTAL_FLOOR_AREA, 0.99, na.rm = T),0) # 270
#min: round(quantile(big_Dt_CSsubset_N6M7$TOTAL_FLOOR_AREA, 0.01, na.rm = T),0), 27m2 
print(paste('The 99 percentile of floor area is: ', maxthreshold, 'm2'))
big_Dt_CSsubset_N6M7[, n_TOTAL_FLOOR_AREA  := ifelse( TOTAL_FLOOR_AREA < 6 ,6, TOTAL_FLOOR_AREA)]
big_Dt_CSsubset_N6M7[, n_TOTAL_FLOOR_AREA  := ifelse( n_TOTAL_FLOOR_AREA > maxthreshold , maxthreshold+1, n_TOTAL_FLOOR_AREA)]


#Edit 6: Make Income deprivation groups (b.)
big_Dt_CSsubset_N6M7[ , n_bIoDDecil_income_grp := cut(n_bIoDDecil_income,
                            breaks = c(0, 3, 7, Inf),
                            include.lowest= TRUE, labels=c('IncomeDeprived_1-3','AverageIncome_4-7','IncomeUnDeprived_8-10'))]

#Edit 6: Make barriers deprivation groups (g.)
big_Dt_CSsubset_N6M7[ , n_gIoDDecil_housing_grp := cut(n_gIoDDecil_barriers,
                            breaks = c(0, 3, 7, Inf),
                            include.lowest= TRUE, labels=c('H&S_Deprived_1-3','AverageAccess_4-7','H&S_UnDeprived_8-10'))]



#Edit 8: Difference in CEE & CEI
big_Dt_CSsubset_N6M7[ , nn_CEE_rating := cut(CURRENT_ENERGY_EFFICIENCY,
                            breaks = c(rev(lettermapping$cutoff), Inf),
                            right = F, #includes the lower value
                            labels=  rev(lettermapping$letter)) ]

big_Dt_CSsubset_N6M7[ , nn_CEI_rating := cut(ENVIRONMENT_IMPACT_CURRENT,
                            breaks = c(rev(lettermapping$cutoff), Inf),
                            right = F, #includes the lower value
                            labels=  rev(lettermapping$letter)) ]

big_Dt_CSsubset_N6M7[ , nn_letter_Diff_CEE_EIC := ifelse(nn_CEE_rating == nn_CEI_rating, 'same letter rate', 
                                                         ifelse(CURRENT_ENERGY_EFFICIENCY > ENVIRONMENT_IMPACT_CURRENT, 'Better Running', 'Less C02') ) ]
```


```{r extreme_values_treatment}
#Edited Variable 1: Potential Change PEE 
big_Dt_CSsubset_N6M7[, nn_potEE := n_POTENTIAL_ENERGY_EFFICIENCY - n_CURRENT_ENERGY_EFFICIENCY]
#Edited Variable 2: Potential Change EIP 
big_Dt_CSsubset_N6M7[, nn_potIE := n_ENVIRONMENT_IMPACT_POTENTIAL - n_ENVIRONMENT_IMPACT_CURRENT]

#Edited Variable 3: Combine all terraced housing
#Old levels: "unknown","End-Terrace","Detached","Mid-Terrace", "Semi-Detached"
big_Dt_CSsubset_N6M7[, nn_builtForm := n_builtForm]
levels(big_Dt_CSsubset_N6M7$nn_builtForm)[levels(big_Dt_CSsubset_N6M7$nn_builtForm)=='End-Terrace'] <- 'Terrace'
levels(big_Dt_CSsubset_N6M7$nn_builtForm)[levels(big_Dt_CSsubset_N6M7$nn_builtForm)=='Mid-Terrace'] <- 'Terrace'
```





```{r CSSubset}
#bonus task: add CO2_EMISSIONS_CURRENT from raw
big_Dt_CSsubset_N6M7
#N = 16 744 771, ncol = 56
names(big_Dt_CSsubset_N6M7)
```
```{r naChecks}
if(F){
#there are no missing values 
nas <- which(is.na(big_Dt_CSsubset_N16M7$CURRENT_ENERGY_EFFICIENCY))
nas <- which(is.na(big_Dt_CSsubset_N16M7$POTENTIAL_ENERGY_EFFICIENCY))
nas <- which(is.na(big_Dt_CSsubset_N16M7$n_potEE))

nas <- which(is.na(big_Dt_CSsubset_N16M7$ENVIRONMENT_IMPACT_CURRENT))
nas <- which(is.na(big_Dt_CSsubset_N16M7$ENVIRONMENT_IMPACT_POTENTIAL))
nas <- which(is.na(big_Dt_CSsubset_N16M7$n_potEIC)) 

#contains nas!
nas <- which(is.na(big_Dt_CSsubset_N16M7$TOTAL_FLOOR_AREA)) 
}
```


```{r}
#anki order vs setorder # https://stackoverflow.com/questions/13685295/sort-a-data-table-fast-by-ascending-descending-order

#big_Dt_CSsubset_N6M7 <- big_Dt_CSsubset_N6M7[order(n_UPRN, -rank(INSPECTION_DATE) ),]
setorder(big_Dt_CSsubset_N6M7, n_UPRN, -INSPECTION_DATE) 


head(big_Dt_CSsubset_N6M7[duplicated(n_UPRN)])
sum(duplicated(big_Dt_CSsubset_N6M7$n_UPRN))#909 529

dupsrm <- big_Dt_CSsubset_N6M7[!duplicated(big_Dt_CSsubset_N6M7$n_UPRN)]

```


```{r NS_dt_censorship}
#Unexplained high values
NS_dt <- dupsrm[ n_CURRENT_ENERGY_EFFICIENCY < 101,] # drops = 3 094 
NS_dt <- NS_dt[ n_ENVIRONMENT_IMPACT_POTENTIAL < 101,] # drops a further = 92 699

NS_dt[, n_CURRENT_ENERGY_EFFICIENCY := NULL]
NS_dt[, n_ENVIRONMENT_IMPACT_POTENTIAL := NULL]

maxthreshold <- round(quantile(dupsrm$TOTAL_FLOOR_AREA, 0.99, na.rm = T),0) 
minthreshold <- round(quantile(dupsrm$TOTAL_FLOOR_AREA, 0.01, na.rm = T),0) 

NS_dt <- NS_dt[ minthreshold < NS_dt$TOTAL_FLOOR_AREA,] # drops a further ~ 167 731 
NS_dt <- NS_dt[ maxthreshold > NS_dt$TOTAL_FLOOR_AREA,] # drops a further ~ 166 758
NS_dt[, n_TOTAL_FLOOR_AREA := NULL]
NS_dt <- NS_dt[ !is.na(TOTAL_FLOOR_AREA),] # checks 

#cannot explain, so removed
NS_dt <- NS_dt[ n_construction_age_band != 'unknown',] # drops 208 708

sample <- lengths(NS_dt )[1] # 16 440 270 
sample

#save( NS_dt , file = "../Outputs/WIP_crossSectional/NS_subset_N16m111443.RData")



#NS_dt[ order( )]
#had dups issue
#save( NS_dt , file = "../Outputs/WIP_crossSectional/NS_subset_N16m440270.RData")
```



