---
title: "P3_CrossSectional_EDA"
author: "Boyana Buyuklieva"
date: "August 30, 2022"
output: html_document
---

```{r}
knitr::opts_chunk$set(echo = TRUE, cache.lazy = FALSE)
library(dplyr)
library(tidyverse)
library(data.table)
library(readr)
library(foreign)
library(ggExtra)
library(gridExtra)

loadRData <- function(fileName){
    #loads an RData file, and returns it
    load(fileName)
    get(ls()[ls() != "fileName"])
}

#formatting:
lettermapping <-  data.frame( letter = c('A','B','C','D','E','F','G'), 
                              cutoff = c(92, 81, 69, 55, 39, 21, 0))


NS_dt_N16m3 <- loadRData("../Outputs/WIP_crossSectional/ONSUD_crossSectional_subset_N16744771.RData")
```




```{r meeting}
check1 <- big_Dt_CSsubset_N6M7[ , by = c('nn_construction_age_band','nn_builtForm', 'PROPERTY_TYPE'),  .(n = .N)]
check1 <- big_Dt_CSsubset_N6M7[ , by = c('nn_construction_age_band'),  .(n = .N)]

dt <- big_Dt_CSsubset_N6M7[ sample(nrow(big_Dt_CSsubset_N6M7), 300),] 

```



```{r histograms}
plot_dt <- NS_dt[ , by = c('nn_builtForm', 'PROPERTY_TYPE'),  .(n = .N)]




#plot_dt$percent <-  plot_dt$n/ sum(plot_dt$n)
plot_dt$nK <- plot_dt$n/1000
  
ggplot(plot_dt, aes(x= nn_builtForm, y=nK))+
  geom_bar(stat='identity')+
  scale_y_continuous(labels = format(seq(0,3800, by = 250), big.mark = ' '),
                     breaks = seq(0,3800, by = 250))+
  facet_grid(PROPERTY_TYPE ~ .) +
  coord_flip()+
  labs( x = '', y = 'Number of properties in 1 000s', )+
  theme(axis.text.y=element_text(angle=30,hjust=1)) +
  theme_minimal()
```






```{r DOESNOTWORK_Figure_building_type}
#marginal histogram will not work
p <-   ggplot(dt, aes(x = nn_CURRENT_ENERGY_EFFICIENCY, colour = nn_construction_age_band )) +
  #geom_density(lwd = 1.2, linetype = 1, position="identity",geom="line", bw = 2)+  
  stat_density(lwd = 1, linetype = 1, position="identity",geom="line", bw = 2)+
  geom_vline( xintercept =  lettermapping$cutoff, colour = 'grey', size=.3)+
  geom_vline( xintercept =  c(69,81), colour = 'black', size=.3)+
  #annotate("text",x = lettermapping$cutoff+5, y= 0.1, label=lettermapping$letter, angle=90, size=5)+
  theme_minimal()+
  theme(legend.position = 'bottom', legend.box = 'horizontal')+
  scale_x_continuous(name = 'Current Energy Efficiency' , breaks= lettermapping$cutoff)+
  facet_grid(rows = vars(nn_builtForm),vars(PROPERTY_TYPE))


pp <-   ggplot(dt, aes(x = as.numeric(nn_builtForm), colour = as.numeric(PROPERTY_TYPE) )) +
        geom_point()

ggMarginal(p, type='histogram')

pp
```

```{r visTest_Figure_CEE_by_EIC}
#add colour by letter difference. 
raw <- ggplot(dt, aes(CURRENT_ENERGY_EFFICIENCY, ENVIRONMENT_IMPACT_CURRENT))+
 # geom_point()+
  geom_point(aes(color = nn_letter_Diff_CEE_EIC)) +
  theme_minimal()+
  theme(legend.position = 'bottom', legend.box = 'horizontal')
  
ggMarginal(raw, type="density")


sample = lengths(dt)[1]

edited <- ggplot(dt, aes(n_CURRENT_ENERGY_EFFICIENCY, n_ENVIRONMENT_IMPACT_CURRENT))+
  geom_point(aes(color = nn_letter_Diff_CEE_EIC)) +
  theme_minimal()+
  theme(legend.position = 'bottom', legend.box = 'horizontal')+
  scale_x_continuous( breaks= lettermapping$cutoff)+
  scale_y_continuous( breaks= lettermapping$cutoff)+
  labs(title = "", subtitle = paste0("Subset n=", sample) )+
  annotate("text",x = lettermapping$cutoff+5, y= 0.1, label=lettermapping$letter, angle=90, size=5)


ggMarginal(edited, type="density")
```












```{r makingdata_smaller}
cols <- c('TOTAL_FLOOR_AREA','NUMBER_HEATED_ROOMS','NUMBER_HABITABLE_ROOMS',
          'n_habitable_rooms_grp','n_CURRENT_ENERGY_EFFICIENCY','n_ENVIRONMENT_IMPACT_CURRENT',
          'n_builtForm','PROPERTY_TYPE','n_tenure','n_bIoDDecil_income_grp', 'n_Crel','CO2_EMISS_CURR_PER_FLOOR_AREA')

#vis_subset_N16M7 <- big_Dt_CSsubset_N6M7[ ,..cols]

SeeRawData <- F
```












```{r subsetting_to_see_buildings}
#big_Dt_CSsubset_N6M7 <- big_Dt_CSsubset_N6M7[!is.na(TOTAL_FLOOR_AREA),]
big_Dt_CSsubset_N6M7[, n_BFPT := paste(n_builtForm, PROPERTY_TYPE)]

set.seed(100)
a <- big_Dt_CSsubset_N6M7[, .SD[sample(.N, 10)], by = n_BFPT]
write_csv(a, file = '../Outputs/sample_building_property_type.csv')


set.seed(100)
big_Dt_CSsubset_N6M7[, n_rBFPT := paste(BUILT_FORM, PROPERTY_TYPE)]
a <- big_Dt_CSsubset_N6M7[, .SD[sample(.N, 5)], by = n_rBFPT]
write_csv(a, file = '../Outputs/sample_raw_building_property_type.csv')


set.seed(100)
a <- big_Dt_CSsubset_N6M7[, .SD[sample(.N, 5)], by = n_rBFPT]
write_csv(a, file = '../Outputs/Age_unknown.csv')
```






