---
title: "P4_Cramer's V"
author: "Bonnie Buyuklieva"
date: "2022-11-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rcompanion)
library(data.table)

#https://www.statology.org/cramers-v-in-r/
#https://www.statology.org/chi-square-test-of-independence-in-r/



source("../Outputs/Thesis_custom_scripts.R", local = knitr::knit_global())
data <- loadRData( "../Data/RData_crossSectional/_NS_dt_N14m377170.RData")

#data <- loadRData( "../Data/RData_crossSectional/_combi_SC_dt_big_crossSect_EPCs_cleaned_N16m984358.RData")
data[ , EXTENSION_COUNT:= as.numeric(EXTENSION_COUNT), ]
```




```{r meta_data_table}
cols <- names(data) # colnames
cols_na <- sapply(data, function(x) sum(is.na(x)))

#count of unique factors
l_unique_factors <- sapply(data, function(x) length(unique(x)))
test1 <- as.data.frame(l_unique_factors)
test <- as.data.frame(do.call(cbind, test1))
type <- sapply(data , function(x) typeof(x)) 

cols <- cbind(names = names(data), 
              type = type,
              nas_counts = cols_na, 
              factors = test)




write.csv(cols, './testMEdel.csv')

```

```{r choose factors}
#get cols with 3-37 factprs

interest_factors_cols <- cols[cols$l_unique_factors < 38 & cols$l_unique_factors > 3, 'names']

#remove some
interest_factors_cols <- setdiff(interest_factors_cols, c("CURRENT_ENERGY_RATING",
                                                          "CONSTRUCTION_AGE_BAND",# harmonised
                                                          "TENURE", # harmonised
                                                          "TRANSACTION_TYPE",# harmonised 
                                                          "GLAZED_TYPE"#GLAZED_TYPE needs harmonising
                                                          ))
```


#for tomorrow: harmonise more from raw.

```{r CramerV}
measure = 'n_CEErel'
output <- data.frame(matrix(nrow = 0, ncol = 6))
  
#Cramer V
for (col in interest_factors_cols) {
  tmp_data <- data[ ,  .(n = .N), by = c(col, measure) ]
  tmp_data <- dcast(tmp_data, paste(col, "~", measure), value.var = 'n')
  
  tmp_cramer_var <- cramerV(as.matrix( tmp_data[,-1] ))
  tmp_chi_var <- chisq.test( tmp_data[,-1] )
  
  
  tmp_chi <- tmp_chi_var$statistic
  tmp_chi_param <- tmp_chi_var$parameter
  tmp_chi_method <- tmp_chi_var$method

  row <- cbind(measure, col, 
        tmp_cramer_var,
        tmp_chi,tmp_chi_param,tmp_chi_method)
  
  output <- rbind.data.frame(output,row)
}

write.csv( output, file = '../Outputs/CramerV_CEErel_3x28_vars.csv')


output2 <- data.frame(matrix(nrow = 0, ncol = 6))
#Cramer V
for (col in interest_factors_cols) {
  tmp_data <- data[ n_CEErel != 'C' ,  .(n = .N), by = c(col, measure) ]
  tmp_data <- dcast(tmp_data, paste(col, "~", measure), value.var = 'n')
  
  tmp_cramer_var <- cramerV(as.matrix( tmp_data[,-1] ))
  tmp_chi_var <- chisq.test( tmp_data[,-1] )
  
  
  tmp_chi <- tmp_chi_var$statistic
  tmp_chi_param <- tmp_chi_var$parameter
  tmp_chi_method <- tmp_chi_var$method

  row <- cbind(measure, col, 
        tmp_cramer_var,
        tmp_chi,tmp_chi_param,tmp_chi_method)
  
  output2 <- rbind.data.frame(output2,row)
}

write.csv( output2 , file = '../Outputs/CramerV_CEErel_2x28_vars.csv')
```




```{r}
#http://www.sthda.com/english/wiki/correlation-test-between-two-variables-in-r
#group | subgroup | method () | cor (estimate)| p (p.value)

start.time <- Sys.time()
cor.test(data$CURRENT_ENERGY_EFFICIENCY, data$ENVIRONMENT_IMPACT_CURRENT,  method="pearson")
Sys.time() - start.time

start.time <- Sys.time()
cor.test(data$CURRENT_ENERGY_EFFICIENCY, data$ENVIRONMENT_IMPACT_CURRENT,  method="spearman")
Sys.time() - start.time
```






## Sample

```{r}
#n_Crel / n_CEErel / nn_CEIrel / n_CEIrel
#Long to Table
sub_data <- data[, .(n = .N) ,by=c('x_simp_nn_builtFormXn_propTyp','n_CEErel') ]
sub_data <- dcast(sub_data, x_simp_nn_builtFormXn_propTyp ~ n_CEErel, value.var = 'n'  )
row.names(sub_data) <- c(sub_data[,1])

#Minus one drops the category names
cramerV(as.matrix(sub_data[,-1]))#0.2098 

#VERSION DROPPING C - LIKELY TO GIVE HIGHER CORRELATION
sub_data1 <- data[ n_CEErel != 'C', .(n = .N) ,by=c('x_simp_nn_builtFormXn_propTyp','n_CEErel') ]
sub_data1 <- dcast(sub_data1, x_simp_nn_builtFormXn_propTyp ~ n_CEErel, value.var = 'n'  )
#Minus one drops the category names
cramerV(as.matrix(sub_data1[,-1]))#0.2456 
```



```{r compareToExpected}
##Compare Chi to Some theoretical
sub_data3 <- data[ n_imd_grp != 'M.Deprived.1-3', .(n = .N) ,by=c('x_simp_nn_builtFormXn_propTyp','n_CEErel') ]
sub_data3 <- dcast(sub_data3, x_simp_nn_builtFormXn_propTyp ~ n_CEErel, value.var = 'n'  )
chisq.test(sub_data3[,-1] , p = sub_data[,-1])
```

```{r resultParams}
#data = matrix(c(7,9,12,8), nrow = 2)
cramerV(data)


a <- cramerV(data, ci = TRUE)

a$Cramer.V
a$lower.ci
a$upper.ci


b <- chisq.test(data1)

b$data.name
b$statistic
b$parameter
b$method
```






```{r get_unique_per_column}
#threashold of factors I care about
interest_factors_cols <- cols[cols$l_unique_factors < 100, 'names']


unique <- data.frame()
for (col in interest_factors_cols) {
  if( is.factor(data[ , col ,with = F]) ){
    row = paste(levels(data[ , col ,with = F]))
  }else{
    row = paste(unique(data[ , col ,with = F]))
  } 
    print(row)
    unique <- rbind(unique,row)
}

unique <-  gsub("[c(]", "",unique)
unique <-  gsub("[)]", "", unique)


cols <- cbind(names = names(data), 
              type = type,
              nas_counts = cols_na, 
              factors = test,
              unique = unique)


test <- c("nn_builtForm","n_propTyp")
test1 <- data[, test ,with = FALSE]
unique_factors <- sapply(test1, function(x) ifelse(is.factor(x), levels(x), unique(x)) )

```

