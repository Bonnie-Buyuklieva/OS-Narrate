---
title: "Tenure - EPCs in V10"
author: "Boyana Buyuklieva"
date: "May 4, 2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("data.table")
library("readxl")

#pulls functions: loadRData(), entries_to_factors()
source("../Outputs/Thesis_custom_scripts.R", local = knitr::knit_global())
```


```{r path}
# #check folders here:
# folders <- list.files(path = "../Data/all-domestic-certificates", pattern = NULL, all.files = FALSE,
#            full.names = FALSE, recursive = FALSE,
#            ignore.case = FALSE, include.dirs = FALSE, no.. = FALSE)
# 
# folders <- folders[-342] #remove the .txt


LAD_region_LUT <- read_excel("../Data/LAD_region_LUT.xlsx")
folders <-  LAD_region_LUT$folder_name
```



```{r building_element}
building_element <- c( 'GLAZED_TYPE','HOTWATER_DESCRIPTION','FLOOR_DESCRIPTION','WINDOWS_DESCRIPTION',
                     'WALLS_DESCRIPTION','SECONDHEAT_DESCRIPTION','ROOF_DESCRIPTION','MAINHEAT_DESCRIPTION',
                     'MAINHEATCONT_DESCRIPTION','LIGHTING_DESCRIPTION')

for (col in building_element) {
  print(col)
  tmp_LUT <- entries_to_factors(column_to_extract_factors_from = col)
  write.xlsx(tmp_LUT,
             file = "../Data/OS-N_EPC_v10_LUT+dictionaries.xlsx", sheetName=col, append=TRUE)
}
```



#Counting on CSV Directory
```{r Generate many_LUTS}
source("../Outputs/Thesis_custom_scripts.R", local = knitr::knit_global())
library("readxl")
LAD_region_LUT <- read_excel("../Data/LAD_region_LUT.xlsx")
folders <-  LAD_region_LUT$folder_name

certificates <- fread(paste0("../Data/all-domestic-certificates/",folders[1],"/certificates.csv"))
#write.csv( sapply(certificates, class) , file = "../Data/certificate_columns.csv" )
#manually select which columns to extract
certificate_columns <- read_csv("../Data/certificate_columns.csv")
certificate_columns_LUT <- certificate_columns$col[!is.na(certificate_columns$to_LUT)]
#View(certificate_columns)

  
for (column in certificate_columns_LUT){
  #column = "BUILT_FORM" # testing
  print(column)
  LUT <- entries_to_factors(column_to_extract_factors_from = column) # loops through folders
  write.xlsx(LUT,#file = "../Data/OS-N_EPC_v10_LUT+dictionaries.xlsx", sheetName=column, append=TRUE)  #manually move here for fewer files
             file = "../Data/OS-N_EPC_v10_LUT+dictionaries_Copy.xlsx", sheetName=column, append=TRUE)
             
}

```


```{r rowCounting_V10_complete}
rowCount<- c('LA','rows')
for (LA in folders) {
  
  #print(LA)
  certificates <- fread(paste0("../Data/all-domestic-certificates/",LA,"/certificates.csv"),
                        select = "LMK_KEY",
                        colClasses = 'character')

  rowCount <- rbind(rowCount, t(c(LA,lengths(certificates))) )
  
}

if(F){
   write.xlsx(rowCount,
             file = "../Data/OS-N_EPC_v10_Overviews.xlsx", sheetName="RawRowTotals", append=TRUE)
}
```

```{r LUT_making}
LUT_built_form <- entries_to_factors(column_to_extract_factors_from = "BUILT_FORM")
LUT_property_type <- entries_to_factors(column_to_extract_factors_from = "PROPERTY_TYPE")
LUT_age_band <- entries_to_factors(column_to_extract_factors_from = "CONSTRUCTION_AGE_BAND")
LUT_transaction <- entries_to_factors(column_to_extract_factors_from = "TRANSACTION_TYPE")

#note: I am not doing tallys here because repeat entries will skew the picture

if(F){
  write.xlsx(LUT_built_form,
             file = "../Data/OS-N_EPC_v10_LUT+dictionaries.xlsx", sheetName="BUILT_FORM", append=TRUE)  
  
  write.xlsx(LUT_property_type,
             file = "../Data/OS-N_EPC_v10_LUT+dictionaries.xlsx", sheetName="PROPERTY_TYPE", append=TRUE) 
  
  write.xlsx(LUT_age_band,
             file = "../Data/OS-N_EPC_v10_LUT+dictionaries.xlsx", sheetName="CONSTRUCTION_AGE_BAND", append=TRUE)
  
  write.xlsx(LUT_transaction,
             file = "../Data/OS-N_EPC_v10_LUT+dictionaries.xlsx", sheetName="TRANSACTION_TYPE", append=TRUE)
}
```



