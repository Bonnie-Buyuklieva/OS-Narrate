---
title: "Tenure - EPCs in V10"
author: "Boyana Buyuklieva"
date: "May 4, 2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("data.table")
library("readxl")

loadRData <- function(fileName){
    #loads an RData file, and returns it
    load(fileName)
    get(ls()[ls() != "fileName"])
}

```



```{r path}
#get folders
folders <- list.files(path = "../Data/all-domestic-certificates", pattern = NULL, all.files = FALSE,
           full.names = FALSE, recursive = FALSE,
           ignore.case = FALSE, include.dirs = FALSE, no.. = FALSE)

folders <- folders[-342] #remove the .txt
```

#Counting on CSV Directory
```{r LUT_making}
entries_to_factors <- function(column_to_extract_factors_from = 'TENURE') {

LUT<- list()
start.time <- Sys.time()

for (LA in folders) {
  
  #print(LA)
  certificates <- fread(paste0("../Data/all-domestic-certificates/",LA,"/certificates.csv"),
                        colClasses = 'character',
                        select = column_to_extract_factors_from)

  LUT[[LA]] <- unique(certificates[,get(column_to_extract_factors_from)])
  
}
#shows which factor is in which folder
folder_to_factor <- as.data.frame(unlist(LUT))
LUT<- as.data.frame(unique(folder_to_factor$`unlist(LUT)`))
colnames(LUT) <- paste0( column_to_extract_factors_from, 'factors')

print(paste('loop time:', Sys.time() - start.time))

return(LUT)
}


LUT_built_form <- entries_to_factors(column_to_extract_factors_from = "BUILT_FORM")
LUT_property_type <- entries_to_factors(column_to_extract_factors_from = "PROPERTY_TYPE")
LUT_age_band <- entries_to_factors(column_to_extract_factors_from = "CONSTRUCTION_AGE_BAND")

LUT_transaction <- entries_to_factors(column_to_extract_factors_from = "TRANSACTION_TYPE")

#note: I am not doing tallys here because repeat entries will skew the picture

if(F){
  write.xlsx(LUT_built_form,
             file = "../Data/OS-N_EPC_v10_LUT+dictionaries.xlsx", sheetName="BUILT_FORM", append=TRUE)  
  
  write.xlsx(LUT_property_type,
             file = "../Data/OS-N_EPC_v10_LUT+dictionaries.xlsx", sheetName="PROPERTY_TYPE", append=TRUE) 
  
  write.xlsx(LUT_age_band,
             file = "../Data/OS-N_EPC_v10_LUT+dictionaries.xlsx", sheetName="CONSTRUCTION_AGE_BAND", append=TRUE)
  
  write.xlsx(LUT_transaction,
             file = "../Data/OS-N_EPC_v10_LUT+dictionaries.xlsx", sheetName="TRANSACTION_TYPE", append=TRUE)
}
```


```{r rowCounting_V10_complete}
rowCount<- c('LA','rows')
for (LA in folders) {
  
  #print(LA)
  certificates <- fread(paste0("../Data/all-domestic-certificates/",LA,"/certificates.csv"),
                        select = "LMK_KEY",
                        colClasses = 'character')

  rowCount <- rbind(rowCount, t(c(LA,lengths(certificates))) )
  
}

if(F){
   write.xlsx(rowCount,
             file = "../Data/OS-N_EPC_v10_Overviews.xlsx", sheetName="RawRowTotals", append=TRUE)
}
```






