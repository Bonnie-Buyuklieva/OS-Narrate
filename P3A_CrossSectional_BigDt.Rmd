---
title: "P3_CrossSectional_EDA"
author: "Boyana Buyuklieva"
date: "August 30, 2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyverse)
library(data.table)
library(readr)
library(foreign)
library(ggExtra)


loadRData <- function(fileName){
    #loads an RData file, and returns it
    load(fileName)
    get(ls()[ls() != "fileName"])
}

big_Dt_CSsubset_N6M7 <- loadRData("../Outputs/WIP_crossSectional/ONSUD_crossSectional_subset_N16744771.RData")

fctr_levels <- c("C+","C","C-")
big_Dt_CSsubset_N6M7[,n_Crel := factor(n_Crel, levels = fctr_levels, ordered = T)]


#multiple deprivation EW
IMD19<- read.dbf("../Data/_shapefiles/Lower_Super_Output_Area_(LSOA)_IMD_2019__(OSGB1936)/Lower_Super_Output_Area_(LSOA)_IMD_2019__(OSGB1936).dbf")

#income deprivation E
income_imd2019lsoa_E <- fread("../Data/imd2019lsoa/imd2019lsoa.csv",
                     drop="Units", #empty column anyway
                     colClasses = c( "FeatureCode" = "character",
                                     "Measurement" = "character",
                                     "Value" = "numeric",
                                     "Indices of Deprivation" = "character"))

#Measurements are: "Rank"   "Decile" "Score"
#income_imd2019lsoa_E <- setNames(income_imd2019lsoa_E, c("lsoa11cd","Date","Measurement","Value","Indices of Deprivation") )
setnames(income_imd2019lsoa_E, c("FeatureCode"), c("lsoa11cd"))

EDA_cols <- read_csv("../Data/EDA_colour_scheme.csv")
#EDA_cols <- subset(EDA_cols[EDA_cols$geography_name %in%  cross_data, ])

#formatting:
lettermapping <-  data.frame( letter = c('A','B','C','D','E','F','G'), 
                              cutoff = c(92, 81, 69, 55, 39, 21, 0))
```


###Editing extreme values to 101
```{r }
#vis_subset_N6M7 <- big_Dt_CSsubset_N6M7[sample(nrow(big_Dt_CSsubset_N6M7), 2000, replace = F ), ]
vis_subset_N6M7 <- big_Dt_CSsubset_N6M7

#The SAP software could generate values over 100, however it is hard to tell which entries are real and which may be errors.
#therefore I am not dropping these over 100, but forcing them all into one group by assigning them to 101. 
vis_subset_N6M7[CURRENT_ENERGY_EFFICIENCY> 100 , CURRENT_ENERGY_EFFICIENCY := 101]
vis_subset_N6M7[POTENTIAL_ENERGY_EFFICIENCY> 100 , POTENTIAL_ENERGY_EFFICIENCY := 101]

vis_subset_N6M7[ENVIRONMENT_IMPACT_CURRENT> 100 , ENVIRONMENT_IMPACT_CURRENT := 101]
vis_subset_N6M7[ENVIRONMENT_IMPACT_POTENTIAL> 100 , ENVIRONMENT_IMPACT_POTENTIAL := 101]

big_Dt_CSsubset_N6M7[, n_potEE := POTENTIAL_ENERGY_EFFICIENCY - CURRENT_ENERGY_EFFICIENCY]
big_Dt_CSsubset_N6M7[, n_potIE := ENVIRONMENT_IMPACT_POTENTIAL - ENVIRONMENT_IMPACT_CURRENT]
```


###IMD:
```{r attached_IMDs}
#multiple deprivation EW
IMD19<- read.dbf("../Data/_shapefiles/Lower_Super_Output_Area_(LSOA)_IMD_2019__(OSGB1936)/Lower_Super_Output_Area_(LSOA)_IMD_2019__(OSGB1936).dbf")

#income deprivation E
income_imd2019lsoa_E <- fread("../Data/imd2019lsoa/imd2019lsoa.csv",
                     drop="Units", #empty column anyway
                     colClasses = c( "FeatureCode" = "character",
                                     "Measurement" = "character",
                                     "Value" = "numeric",
                                     "Indices of Deprivation" = "character"))

#Measurements are: "Rank"   "Decile" "Score"
#income_imd2019lsoa_E <- setNames(income_imd2019lsoa_E, c("lsoa11cd","Date","Measurement","Value","Indices of Deprivation") )
setnames(income_imd2019lsoa_E, c("FeatureCode"), c("lsoa11cd"))

EDA_cols <- read_csv("../Data/EDA_colour_scheme.csv")
#EDA_cols <- subset(EDA_cols[EDA_cols$geography_name %in%  cross_data, ])

#formatting:
lettermapping <-  data.frame( letter = c('A','B','C','D','E','F','G'), 
                              cutoff = c(92, 81, 69, 55, 39, 21, 0))

#Add IMD
big_Dt_CSsubset_N6M7[IMD19,  on = 'lsoa11cd', c('n_IMDRank','n_IMDDecil') := .(IMDRank,IMDDecil)]

#Add IoD
##can select other IoD here
imd_bincome <-  income_imd2019lsoa_E[ `Indices of Deprivation` == "b. Income Deprivation Domain",]
imd_bincome <-dcast(imd_bincome, lsoa11cd ~ Measurement, value.var = c("Value"))
big_Dt_CSsubset_N6M7[imd_bincome,  on = 'lsoa11cd', c('n_bIoDRank_income','n_bIoDDecil_income') := .(Rank,Decile)]
```

```{r IMD IoDb comparison}
#How does IMD compare to Income ID in England Only?
##Scatter plot

#ggplot(tmp[!is.na(n_bIoDRank_income), ],
ggplot(big_Dt_CSsubset_N6M7[!is.na(n_bIoDRank_income), ],
       aes(x=n_IMDRank, y=n_bIoDRank_income, color=n_Crel)) +
  geom_point(alpha = 1/10) + 
  geom_smooth(method=lm, se=FALSE, fullrange=TRUE)+
  scale_colour_manual(values = c("C+" = "#ffa600", "C" = "#808080", "C-" = "#008cff"))


if(F){
model_Cplus <- lm(n_IMDRank ~ n_bIoDRank_income, 
            data = big_Dt_CSsubset_N6M7[!is.na(n_bIoDRank_income) & n_Crel=="C+", ])
summary(model_Cplus)

model_Cminus <- lm(n_IMDRank ~ n_bIoDRank_income, 
            data = big_Dt_CSsubset_N6M7[!is.na(n_bIoDRank_income) & n_Crel=="C-", ])
summary(model_Cminus)

model_C <- lm(n_IMDRank ~ n_bIoDRank_income, 
            data = big_Dt_CSsubset_N6M7[!is.na(n_bIoDRank_income) & n_Crel=="C", ])
summary(model_C) 
}
```

```{r CEE and EIC relationship}
#https://r-graph-gallery.com/277-marginal-histogram-for-ggplot2.html
#ggplot(tmp,
ggplot(big_Dt_CSsubset_N6M7[ ENVIRONMENT_IMPACT_CURRENT<101],
       aes(x=nn_CURRENT_ENERGY_EFFICIENCY, y=ENVIRONMENT_IMPACT_CURRENT, color=n_Crel)) +
  geom_point(alpha = 1/10) + 
  geom_smooth(method=lm, 
              se=FALSE, 
              fullrange=F)+
  scale_colour_manual(
    values = c("C+" = "#ffa600", "C" = "#808080", "C-" = "#008cff"))
```





